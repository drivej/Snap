var Snap=function(){function getAttribute(e,t,a){if(e[0].hasAttribute(t)){var r=e.attr(t);if(r)return r}return a}function defaultTemplate(e){return"No Template. Data: "+JSON.stringify(e,null,2)}function removeWatcher(e){watchers[e.key][e.index]=null}function cleanupElement(e){var t,a;$("[snap-ctrl]",e).each(function(e,r){t=getElementController(r),a=t.getConfig(),watcher=t.getWatcher(),watchers[watcher.key][watcher.index]=null,watchersReuse[watcher.key]||(watchersReuse[watcher.key]=[]),watchersReuse[watcher.key].push(watcher.index)})}function defaultController(e){function t(e){cleanupElement(s.$el),s.$el.html(getTemplate(s.tmpl)(e)),render(s.$el)}function a(e){$.extend(s,e),n()}function r(e){return s}function n(){t(getData(s.dataKey))}function o(){return l}var s=getElementConfig(e),l=watchData(s.dataKey,t);return{setConfig:a,getConfig:r,getWatcher:o}}function setController(e,t){controls[e]=t}function getController(e){return controls[e]||defaultController}function getControlInstance(e){return controlInstance[parseInt(e)]}function getElementController(e){var t,a=$(e)[0].hasAttribute("snap-ctrl");if(a)return t=$(e).attr("snap-ctrl"),getControlInstance(t);var r=$(e).parents("[snap-ctrl]");return r.length>0?(t=$(r).attr("snap-ctrl"),getControlInstance(t)):null}function getElementConfig(e){var t=$(e),a=$(e)[0],r=a.hasAttribute("data-tmpl");if(r||(t=t.parents("[data-tmpl]")),0===t.length)return!1;a=t[0];var n,o,s=a.hasAttribute("data-ref");if(s)n=parseInt(t.attr("data-ref"));else{n=elementIndex++;var l=getAttribute(t,"data-tmpl","defaultTemplate"),c=getAttribute(t,"data-ctrl",l),u=getAttribute(t,"data-watch",!1);u===!1&&(u=l,null===getData(l)&&setData(l,!1)),elementRef[n]={index:n,$el:$(e),el:$(e)[0],tmpl:l,ctrl:getController(c),dataKey:u,lastRendered:0,rendered:!1,initialized:!1,changeIndex:null},t.attr("data-ref",n)}return o=elementRef[n]}function render(e,t){if(debug>3&&console.log("Snap.render()",t),e||(e=document.body),!(t>20)){var a=$(e),r=getElementConfig(e);r&&r.initialized===!1&&(r.initialized=!0,a.attr("snap-ctrl",controlInstance.push(new r.ctrl(e))-1)),t=(t||0)+1,$("[data-tmpl]",e).each(function(e,a){render(a,t)})}}function setTemplate(e,t){debug>1&&console.log("Snap.setTemplate()",e),templates[e]="string"===$.type(t)?Handlebars.compile(t):t,Handlebars.registerPartial(e,templates[e]),dispatchChange(e)}function getTemplate(e){return templates[e]||defaultTemplate}function watchData(e,t){debug>1&&console.log("watchData",e);var a=e.replace(/^.+?(?=[\[\.])/,""),r=e!==a;r&&(e=e.match(/^.+?(?=[\[\.])/)[0]),watchers[e]||(watchers[e]=[]);var n,o={callback:t,path:a,deep:r,key:e};watchersReuse[e]&&watchersReuse[e].length>0?(n=watchersReuse[e].pop(),watchers[e][n]=o):n=watchers[e].push(o)-1,o.index=n;var s=getData(e);return null!==s&&runWatcher(o,s),o}function audit(){var e=0;for(var t in watchers)e+=watchers[t].length;console.log("TOTAL WATCHERS:",e)}function dispatchChange(e){if(debug>2&&console.log("Snap.dispatchChange()",e),watchers[e]){var t=getData(e);if(t)for(var a=watchers[e].length;a--;)runWatcher(watchers[e][a],t)}}function runWatcher(watcher,data){watcher&&watcher.callback&&(watcher.deep===!0&&(data=eval("data"+watcher.path)),void 0!==data&&watcher.callback(data))}function setDataConfig(e,t){debug>1&&console.log("Snap.setDataConfig",e);var a=dataConfig[e]=$.extend(getDataConfig(e),t);t.defaultValue&&alert("Snap update: Change defaultValue to defaultData in "+e);var r=datas[e]||a.defaultData||null;if(a.useLocalStorage){var n=window.localStorage.getItem(e);if(null!==n&&"undefined"!==n)try{r=$.parseJSON(n)}catch(t){debug&&console.error(e,"localstorage failed json parse",r,n)}}if(a.process&&$.isFunction(a.process))try{r=a.process(r)}catch(t){debug&&console.error("Snap.setDataConfig() config.process",e)}r&&setData(e,r)}function flushLocalStorage(e){window.localStorage.removeItem(e)}function getDataConfig(e){return dataConfig[e]||{defaultData:"",useLocalStorage:!1,process:!1,changeIndex:0}}function getData(e){(e instanceof jQuery||e&&e.tagName)&&(e=getElementDataKey(e)),debug>1&&console.log("Snap.getData()",e);var t=null;if(e in datas)t=datas[e];else{var a=dataConfig[e];a&&a.defaultData&&(t=a.defaultData)}return t}function getElementDataKey(e){var t=getElementConfig(e);return t?t.dataKey:null}function setData(e,t,a){(e instanceof jQuery||e&&e.tagName)&&(e=getElementDataKey(e)),debug&&console.log("Snap.setData()",e),dataConfig[e]||(dataConfig[e]={changed:!0});var r=dataConfig[e];r.changeIndex++,a=$.extend({overwrite:!1,triggerChange:!0},a||{});var n=t,o=getData(e);if($.isFunction(t))n=t(o);else if(datas[e]&&a.overwrite!==!0)switch($.type(datas[e])){case"array":"array"===$.type(t),n=t;break;case"object":n=a.deep===!0?$.extend(!0,{},o,t):$.extend({},o,t);break;case"string":case"number":default:n=t}else n=t;if(r.process)try{n=r.process(n,o)}catch(t){debug&&console.error("Snap.setData() config.process",e)}if(processors[e])for(var s=0;s<processors[e].length;s++)n=processors[e][s](n,o);datas[e]=n,r.useLocalStorage&&window.localStorage.setItem(e,JSON.stringify(n)),a.triggerChange!==!1&&dispatchChange(e)}function addProcess(e,t,a){processors[e]||(processors[e]=[]),a||(a={}),a.priority||(a.priority=processors[e].length),processors[e].push(t),processors[e].sort(function(e,t){return e.priority<t.priority?-1:e.priority>t.priority?1:0})}function handleAjaxComplete(e){this.process&&(e=this.process(e)),this.dataKey&&setData(this.dataKey,e,{overwrite:this.overwrite===!0}),this.callback&&this.callback(e),requestStatus=0,requestQueue.length&&nextRequest()}function handleAjaxError(){console.log("Snap.handleAjaxError() There was an error"),this.data={error:!0,errorMessage:"Unknown error."},handleAjaxComplete(this)}function nextRequest(){if(!(requestStatus>0)){requestStatus=1;var e=requestQueue.pop();debug>0&&console.log("Snap.request()",e),$.ajax($.extend({dataType:"json",error:handleAjaxError,success:handleAjaxComplete},e))}}function request(e){requestQueue.push(e),nextRequest()}function setDebug(e){debug=$.isNumeric(e)?e:e?1:0}var debug=0,controls={},templates={},watchers={},watchersReuse={},datas={},dataConfig={},processors={},requestQueue=[],requestStatus=0,elementIndex=0,elementRef=[],controlInstance=[];return Handlebars.registerHelper("snaptmpl",function(e,t,a){if(!e||!t)return"";$.extend(t,a?a.hash:{});var r=Handlebars.partials[e];return r?new Handlebars.SafeString(r(t)):""}),{audit:audit,request:request,setController:setController,getController:getController,getControlInstance:getControlInstance,render:render,getElementConfig:getElementConfig,getElementController:getElementController,setTemplate:setTemplate,getTemplate:getTemplate,watchData:watchData,dispatchChange:dispatchChange,getData:getData,setData:setData,setDataConfig:setDataConfig,setDebug:setDebug,addProcess:addProcess,setProcess:addProcess,getElementDataKey:getElementDataKey,getWatchers:function(){return watchers},flushLocalStorage:flushLocalStorage}}();